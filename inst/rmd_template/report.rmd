---
title: "Field training point summary report"
output: html_document
params:
  tpts: tpts
  trans: trans
  out_dir: out_dir
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=FALSE,
                      warning = FALSE, message = FALSE,
                      results = 'show',  fig.width = 14,
  fig.height = 10,eval = TRUE)  ## flag eval = false for quick text edits
```


```{r global_options, include=FALSE}

## Load library
library(data.table)
library(rmarkdown)
library(knitr)
library(dplyr)
library(ggplot2)

tpts <- params$tpts
trans <- params$trans
out_dir <- params$out_dir

```


# type of points

```{r}
ptsdf <- tpts %>%
  sf::st_drop_geometry()

pttype <- ptsdf  %>% 
  dplyr::select(data_type) %>%
  group_by(data_type)%>%
  dplyr::mutate(count = n()) %>%
  dplyr::distinct()

kable(pttype)

```
# length of transect segments

```{r}

all_trans <- trans %>%  
    mutate(length = st_length(.)) %>%
    st_drop_geometry() 

#all_trans_i <- all_trans %>%
#  dplyr::filter(data_type == "incidental")

# total type of points with primary and secondary 
trans_type_p <- all_trans %>%
  dplyr::group_by(data_type) %>%
  dplyr::summarise(primary = sum(length, na.rm = TRUE))

trans_type_s <- all_trans %>%
  filter(!is.na(mapunit2)) %>%
  group_by(data_type) %>%
  dplyr::summarise(secondary = sum(length, na.rm = TRUE))

trans_type <- left_join(trans_type_p, trans_type_s) %>%
  mutate(pc.sec = round((secondary/primary * 100),1))

trans_type_long <- left_join(trans_type_p, trans_type_s) %>%
  mutate(pc.sec = secondary/primary * 100)

trans_types <- unique(trans_type$data_type)

```

A total length of `r round(sum(trans_type$primary),1)` meters was surveyed during transect collection. This include `r round(length(trans_type$data_type),1)` data types : `r trans_types`.

Alternate calls were made for `r round(sum(trans_type$secondary, na.rm = TRUE),2)` meters, with an average of `r round(sum(trans_type$secondary, na.rm = TRUE)/sum(trans_type$primary, na.rm = TRUE)*100, 1) ` % of all calls.

```{r}
kable(trans_type)
```

# number of points per transects

```{r}
nopts <- ptsdf  %>% 
  dplyr::select(transect_id) %>%
  group_by( transect_id) %>%
  mutate(count = n()) %>%
  distinct()

kable(nopts)

```

# Observers

```{r, eval = FALSE}

noobs <- ptsdf  %>% 
  dplyr::select(observer) %>%
  group_by(observer) %>%
  mutate(count = n()) %>%
  distinct()

kable(noobs)
```


# Call type

# Primary and Secondary Calls

```{r, eval = FALSE}
# total type of points with primary and secondary 
pt_type_p <- ptsdf  %>%
  group_by(data_type) %>%
  dplyr::summarise(all.calls = n())

pt_type_s <- ptsdf %>%
  filter(!is.na(mapunit2)) %>%
  group_by(data_type) %>%
  dplyr::summarise(sec.calls = n())

pt_type <- left_join(pt_type_p, pt_type_s) %>%
  mutate(percent.sec = sec.calls/all.calls * 100)

#pt_types <- unique(pt_type$data_type)

kable(pt_type)

```

```{r, echo = FALSE, fig.width = 10, fig.height=10}
#all_trans

trans_f <- all_trans %>%
  mutate(mapunit2 = ifelse(mapunit2 == "", NA, mapunit2),
         mapunit1 = ifelse(mapunit1 == "", NA, mapunit1)) %>%
  group_by(mapunit1, mapunit2) %>%
  dplyr::summarise(length = sum(length)) %>%
  ungroup()
  
# primary calls: 
trans_f_p <- trans_f %>%
  filter(is.na(mapunit2)) 

# format secondary calls:
trans_f_s12 <- trans_f %>%
  filter(!is.na(mapunit2)) %>%
  mutate(order = "mapunit12")
       
trans_f_s21 <- trans_f %>%
  filter(!is.na(mapunit2)) %>%
  mutate(order = "mapunit21",
         mapunit3 = mapunit1, 
         mapunit4 = mapunit2) %>%
  dplyr::select(-c(mapunit1, mapunit2)) %>%
  dplyr::rename(mapunit1 = mapunit4, 
                mapunit2 = mapunit3)

trans_secondary <- bind_rows(trans_f_s12, trans_f_s21) %>%
  arrange(mapunit1, mapunit2) %>%
  group_by(mapunit1, mapunit2) %>%
  dplyr::summarise(length = sum(length)) 

trans_secondary_f1 <- trans_secondary %>%
  group_by(length) %>%
  arrange(length, group_by = TRUE) %>%
  aggregate(.~length, . , FUN=head, 1) %>%
  dplyr::select(mapunit1, mapunit2, length)%>%
  arrange(mapunit1) %>%
  mutate(length = round(length, 2))


trans_summary <- bind_rows(trans_f_p, trans_secondary_f1) 
  
trans_total <- trans_summary %>%
  arrange(mapunit1) %>%
  rowwise() %>%
  mutate(bgc = unlist(strsplit(mapunit1, "/"))[1]) %>%
  mutate(bgc = ifelse(stringr::str_detect(mapunit1, "/"), bgc, "non-forest")) %>%
  ungroup() %>%
  mutate(length = as.numeric(round(length, 1))) %>%
  filter(!is.na(mapunit1)) %>%
  mutate(mapunit12 = ifelse(is.na(mapunit2), mapunit1, paste0(mapunit1, "/", mapunit2)))

bgc_list <- unique(trans_total$bgc)

```

The length of calls per bgc varied, along with proportion of primary and secondary calls. Figures below show the length of calls for all data types grouped by predominant bgc.

```{r, echo = FALSE, fig.width= 12, fig.height = 16}
# plot the freqency 

for(b in bgc_list) {
 # b = unique(pt_total$bgc)[3]
  pt_total_bgc <- trans_total %>%
    filter(bgc == b)
  
  p <- ggplot(pt_total_bgc , aes(y = reorder(mapunit12, length), x = length)) +
  geom_bar(stat = "identity") + 
  labs(title = b, y = "mapunit")
  
  print(p)
  
}

```


```{r, eval = FALSE}

# group by observer
all_trans_ob <- all_trans %>%
  dplyr::group_by(transect_id) %>%
  tidyr::fill(observer, .direction = "downup")

all_trans_ob_sum <- all_trans_ob %>%
   group_by(transect_id, observer) %>%
   dplyr::summarise(count = n())

trans_ob_p <- all_trans_ob %>%
 # dplyr::filter(is.na(mapunit2)) %>%
  group_by(observer) %>%
  summarise(all.calls = sum(length))

trans_ob_s <- all_trans_ob %>%
  dplyr::filter(!is.na(mapunit2)) %>%
  group_by(observer) %>%
  summarise(sec.calls = sum(length))

trans_obs_type <- left_join(trans_ob_p, trans_ob_s) %>%
  mutate(pc.sec = round((sec.calls/all.calls * 100),1))

trans_obs_type<- trans_obs_type %>%
  mutate(observer = case_when(
    observer == "EAC GP" ~ "EAC",
    observer == "EAC GCP" ~ "EAC",
    observer == "EC" ~ "EAC",
    observer == "CC LJ" ~ "CC",
    observer == "DF LJ" ~ "DF",
    observer =="DJM DF" ~ "DJM",
    observer == "PD AR" ~ "PD", 
    observer =="SRan" ~ "SR",
    observer == "SR/MZ" ~ "SR",
    observer == "WM" ~ "WHM",
        TRUE ~ observer)) %>%
      group_by(observer) %>%
      summarise(across(where(is.numeric), sum)) %>%
  mutate(pc.sec = round(sec.calls/all.calls * 100,1))


```

There were `r length(trans_ob_s$observer)` observers recording data, including unnamed recorders (NA). The table below shows the total calls and the proportion of calls which also had a secondary call. The average proportion of transect length that has a secondary call was `r mean(trans_ob_s$pc.sec)`. Note this data does not include repeat transects, in which multiple observers recorded at the same location. 

```{r, results  = "asis", hide = TRUE, echo = FALSE}

kable(trans_obs_type)

```



