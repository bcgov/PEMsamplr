---
title: "Generate sample plan"
output: rmarkdown::html_vignette
vignette: >
  #%\VignetteIndexEntry{PEMsamplr}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}

library(PEMprepr)
library(PEMsamplr)
library(sf)

```


## Run Cost-Constrained Sliced cLHS

A cLHS can now be run on this constrained sample space and any point selected will be support a valid transect no matter the rotation. 
cLHS sets are generated for each subzone individually.
We apply a minimum 1000m spacing between cLHS points to prevent possible overlap of paired transects.
  
We created five cLHS 'slices' of 5 sites (n=25) for sampling. Each slice represents a cLHS independently so all sites from a slice must be sampled. Strictly speaking the slices must be sampled in order to maintain LHS structure as well (i.e. 1 + 2 + 3 = LHS but 1 + 2 + 4 may not be LHS). A progressive cLHS procedure has been proposed that makes any combination of slices maintain LHC structure.

Additional new cLHS slices can be created after the generation of the original run using the 'include' parameter in the cLHS function. Where sampling may involve helicopter access, additional slices could be added using a cost layer where landable clearings rather than roads are the zero cost starting points.


```{r}
# set up folder for sample plan
devtools::install_github("kdaust/clhs") 

# set output folder for clhs plans
clhs_outpath <- fid$samplingplan_clhs[2]
ifelse(!dir.exists(clhs_outpath), dir.create(clhs_outpath, recursive = TRUE), FALSE)

# read in the landscape covariates + cost and stack 

landscape_dir <- 'D:/PEM_DATA/PEMsamplr/CanyonCreek/20_sample_plan/10_standard_sample/10_input_raster/landscape_covariates'

fileoi <- c("dah_LS.tif", "mrvbf_LS.tif", "landform_LS.tif", "cost.tif")

filesoi <- list.files(outpath, full.names = TRUE)[list.files(outpath) %in% fileoi]

all_cov <- terra::rast(filesoi)


# read in bec labels 

bec_dir = "D:\\PEM_DATA\\PEMsamplr\\CanyonCreek\\20_sample_plan\\10_standard_sample\\10_input_raster\\exclusion" 

boi <- list.files(bec_dir, pattern = ".tif")

# for each Bec unit generate multiple plans

for(b in boi) {
  #b <- boi[1]
  boi_mask <- terra::rast(file.path(bec_dir, b)) 
  names(boi_mask) = "mask"
  bname <- gsub("_exclude_mask.tif", "", b)
  
  sample_layers_masked <- c(all_cov, boi_mask) %>%  
    terra::mask(boi_mask) 
  sample_layers_masked <- sample_layers_masked[[1:4]]
  
# create 10 different sample plans
  
  for(rot in 1:5){ 
    
    sample_points <- create_clhs(all_cov = sample_layers_masked, 
                                 num_slices = 2, 
                                 to_include = NULL, 
                                 n_points = 5 , 
                                 min_dist = 1000,
                                 num_sample = 5000000)
    
    sf::st_write(sample_points, file.path(clhs_outpath, paste0(bname,"_clhs_sample_",rot,".gpkg")))
    
  }
  
} 

```

# select the clhs with the lowest sample cost

1) Using simple cost metrics 
2) Using vehicle routing problem 

```{r}
library(foreach)
# read in all the points per bgc, collate and assign value based on travel cost
 
ftemp <- list.files(clhs_outpath, pattern = ".gpkg$", full.names = TRUE)

all_samples <- foreach(fs = 1:length(ftemp), .combine = "rbind" ) %do% {
  
  ff <- ftemp[fs]
  layers <- st_layers(ff)$name
  
  sample_points_all <- foreach(l = 1:length(layers), .combine = rbind) %do% {
    ll = layers[l]
    sptemp <- st_read(ff, layer = ll)
    sptemp <- sptemp %>%
      dplyr::mutate(clhs_repeat = basename(ff)) %>% 
      dplyr::mutate(bgc = stringr::str_extract(layers, "[^_]+"))
 
    sptemp
  }
  
}

# summarise the costs per sample plan
repsum <- all_samples %>%
  sf::st_drop_geometry() %>%
  dplyr::select(clhs_repeat, bgc, cost)

repsum <- repsum %>%
  dplyr::group_by(clhs_repeat, bgc) %>%
  dplyr::mutate(tcost = sum(cost)) %>%
  dplyr::select(-cost) %>%
  dplyr::distinct()

# plot the total costs by subzone
p1 <- ggplot(repsum, aes(y = tcost, x =  clhs_repeat )) +
  geom_point()+
  facet_wrap(~bgc, scales = "free_x")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
p1

```

2) Alternatively run Vehicle routing problem 

```{r}
# set up start location
vec_dir = "D:\\PEM_DATA\\PEMsamplr\\CanyonCreek\\10_clean_inputs\\10_vector"
cities <- st_read(file.path(vec_dir, "major_towns_bc.gpkg"))
nearest_town = "Granisle"
start <- cities[cities$NAME == nearest_town,"NAME"]

## THis needs work to complete vrp 

```



3) Generate the additional transect information 

```{r}

sampleplan_outdir <- "D:\\PEM_DATA\PEMsamplr\\CanyonCreek\\20_sample_plan\\10_standard_sample\\30_sampleplan_final\\transect"
  
clhs_dir <- list.files(file.path("D:\\PEM_DATA\\PEMsamplr\\CanyonCreek\\20_sample_plan\\10_standard_sample\\20_sampleplan_draft\\clhs"), full.names = T)
  
clhs_final <- sf::st_read(clhs_dir[16])

landscape_dir <- 'D:/PEM_DATA/PEMsamplr/CanyonCreek/20_sample_plan/10_standard_sample/10_input_raster/landscape_covariates'

cost <- terra::rast(file.path( landscape_dir, "cost.tif"))


mask <- 
  
  
pem_create_maps <- function(sample_points, out_name, centroid_distance = 400){
  
 sample_points =  clhs_final 
 b = unique(ptCoords$subzone)

```



