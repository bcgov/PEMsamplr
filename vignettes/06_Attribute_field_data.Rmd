---
title: "06_Attribute_field_data.Rmd"
author: "G. Perkins"
date: "2023-03-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Mapping resolution and mapping units 

In many of the site series we can roll up finner classification into broader groups. To do this we need to use a build to match field calls to map units. 

In this case we have a pre-populated legend. 

Once the final level of modelling is decided we convert points to line segments, and then extract all points of the raster size in whcih we will model with, default of 5m. 



## Prepare and attribute all training data points 

We can choose to extract all adjoining points for each training point. 
This process is done to overcome spatial missregulation errors. 


```{r libraries}

load_all()
library(PEMprepr)
library(sf)
library(terra)

```

Create the set of folders is not already running from previous scripts

```{r}
# set up the folder names
fid <- setup_folders("CanyonCreek")

map.key  <- read.csv(file.path(fid$AOI_dir[2], "DateCreek_MapUnitLegend.csv"), stringsAsFactor = FALSE)

# clean points 
cleandat <- fid$trainpts_maps[2]

res_folder = "5m"

#location of raster base on which modelling will be applied
covdir <- fid$cov_dir_1020[2]

# location of attributed and output data 
outdat <- fid$training_data_1030[2]

```

Add the adjoining cells 

```{r}
#read in the cleaned trianing points

tpoints <- st_read(file.path(cleandat, "s1_points.gpkg"))

tlines <- st_read(file.path(cleandat, "proc_s1.gpkg"))








# read in the raster template used for modelling (i.e 5m resolution)
trast <- terra::rast(file.path(covdir, res_folder,"template.tif"))

#dat_pts <- tpoints 
#template <- trast

tpoints_ne <- add_neighbours(tpoints,trast)


```

Attribute all the data 


```{r}

head(tpoints_ne)

# location of covariates to intersect with
# read in the raster template used for modelling (i.e 5m resolution)


allrasts <- file.path(covdir, res_folder)

allpts <- attribute_points(tpoints_ne, allrasts) 

st_write(allpts, dsn = file.path(fid$training_data_1030[2], "allpts.gpkg"), delete_layer = TRUE)

```

